<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Estoque Caratininga</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Recharts (Gráficos) -->
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
            PieChart, Pie, Cell, ComposedChart, Line, LabelList
        } = Recharts;
        const { 
            TrendingDown, Calendar, AlertCircle, CheckCircle, TrendingUp, 
            LayoutGrid, Table, History, MapPin, Building2, Lock,
            Truck, Info, DollarSign, Activity, ShoppingCart, PackageX, BarChart3,
            Moon, Sun, Filter
        } = lucide;

        // --- UTILITÁRIOS ---
        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
        const formatDate = (dateStr) => {
            if (!dateStr) return "-";
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}`;
        };

        // --- COMPONENTES AUXILIARES ---
        const StatusBadge = ({ type, text }) => {
            const colors = {
                critico: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100',
                atencao: 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-100',
                ok: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100',
                morto: 'bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-300',
                lento: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100'
            };
            return <span className={`px-2 py-1 rounded text-xs font-bold ${colors[type] || colors.ok}`}>{text}</span>;
        };

        const LoginScreen = ({ onLogin }) => {
            const [pass, setPass] = useState("");
            const [error, setError] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (pass === "1337") onLogin();
                else setError(true);
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
                        <div className="flex justify-center mb-6">
                            <div className="bg-blue-100 p-3 rounded-full"><Lock className="text-blue-600 w-8 h-8" /></div>
                        </div>
                        <h2 className="text-2xl font-bold text-center text-slate-800 mb-2">Acesso Restrito</h2>
                        <p className="text-center text-slate-500 mb-6">Controle de Perdas Caratininga</p>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Senha de Acesso</label>
                                <input 
                                    type="password" value={pass} onChange={(e) => { setPass(e.target.value); setError(false); }}
                                    className="w-full border border-slate-300 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all font-mono text-lg"
                                    placeholder="••••" autoFocus
                                />
                            </div>
                            {error && <div className="text-red-500 text-sm font-medium flex items-center gap-2 bg-red-50 p-3 rounded-lg"><AlertCircle size={16} /> Senha incorreta.</div>}
                            <button type="submit" className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg transition-all active:scale-95">Entrar no Sistema</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- LÓGICA DE DADOS (DATA FETCHING) ---
        
        // Mapeamento das pastas no GitHub
        const FILIAIS_CONFIG = {
            "GRACA": { nome: "Graça (Matriz)", path: "graca" },
            "MUCAMBO": { nome: "Mucambo (Filial)", path: "mucambo" },
            "FRECHEIRINHA": { nome: "Frecheirinha (Filial)", path: "frecheirinha" },
            "TIANGUA": { nome: "Tianguá (Filial)", path: "tiangua" }
        };

        const useDadosReais = (unidadeSelecionada, categoriaFilter) => {
            const [dados, setDados] = useState(null);
            const [catalogo, setCatalogo] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // 1. Carregar Catálogo (apenas uma vez)
            useEffect(() => {
                fetch('data/catalogo.json')
                    .then(res => res.json())
                    .then(data => setCatalogo(data))
                    .catch(err => console.error("Erro ao carregar catálogo:", err));
            }, []);

            // 2. Carregar Dados da Unidade
            useEffect(() => {
                if (!catalogo) return;

                const carregarDados = async () => {
                    setLoading(true);
                    setError(null);
                    
                    try {
                        if (unidadeSelecionada === 'TODAS') {
                            // Carrega tudo de todas as filiais para consolidar
                            const promises = Object.keys(FILIAIS_CONFIG).map(async (key) => {
                                const config = FILIAIS_CONFIG[key];
                                const [contagens, vendas, entradas] = await Promise.all([
                                    fetch(`data/${config.path}/contagens.json`).then(r => r.json()).catch(() => []),
                                    fetch(`data/${config.path}/vendas.json`).then(r => r.json()).catch(() => ({})),
                                    fetch(`data/${config.path}/entradas.json`).then(r => r.json()).catch(() => ({}))
                                ]);
                                
                                const unidadeDados = { contagens, vendas, entradas };
                                const ultimoPeriodo = contagens.length - 1;
                                // Calcula KPIs para o último período desta filial
                                const kpis = calcularKPIsUnidade(unidadeDados, ultimoPeriodo, categoriaFilter, key, catalogo);
                                
                                return {
                                    nome: config.nome,
                                    dataRef: kpis ? kpis.periodoLabel : 'N/A',
                                    dados: kpis
                                };
                            });

                            const resultados = await Promise.all(promises);
                            setDados({ tipo: 'CONSOLIDADO', filiais: resultados });

                        } else {
                            // Carrega apenas a unidade selecionada
                            const config = FILIAIS_CONFIG[unidadeSelecionada];
                            const [contagens, vendas, entradas] = await Promise.all([
                                fetch(`data/${config.path}/contagens.json`).then(r => r.json()),
                                fetch(`data/${config.path}/vendas.json`).then(r => r.json()),
                                fetch(`data/${config.path}/entradas.json`).then(r => r.json())
                            ]);

                            setDados({ 
                                tipo: 'INDIVIDUAL', 
                                unidade: { contagens, vendas, entradas }, 
                                key: unidadeSelecionada 
                            });
                        }
                    } catch (err) {
                        console.error("Erro no carregamento:", err);
                        setError("Falha ao carregar dados. Verifique os arquivos JSON.");
                    } finally {
                        setLoading(false);
                    }
                };

                carregarDados();
            }, [unidadeSelecionada, categoriaFilter, catalogo]);

            return { dadosBI: dados, loading, error, catalogoFull: catalogo };
        };

        // --- LÓGICA DE NEGÓCIO ---

        const getCatalogoPorData = (catalogoFull, dataContagem) => {
            if (!catalogoFull) return {};
            const datasDisponiveis = Object.keys(catalogoFull).sort();
            const dataValida = datasDisponiveis.reverse().find(d => d <= dataContagem) || datasDisponiveis[0];
            return catalogoFull[dataValida] || {};
        };

        const getPrecosFilial = (produto, nomeFilial) => {
            if (!produto || !produto.filiais) return { custo: 0, venda: 0 };
            let dados = produto.filiais[nomeFilial];
            // Fallback para Matriz se não tiver preço específico
            if (!dados || dados.custo === 0) dados = produto.filiais["GRACA"];
            if (!dados) return { custo: 0, venda: 0 };
            return { custo: dados.custo, venda: dados.preco_venda };
        };

        const calcularKPIsUnidade = (dadosUnidade, indicePeriodo, categoriaFilter, nomeFilialKey, catalogoFull) => {
            if (!dadosUnidade || !dadosUnidade.contagens || !dadosUnidade.contagens[indicePeriodo] || indicePeriodo === 0) return null;

            const atual = dadosUnidade.contagens[indicePeriodo];
            const anterior = dadosUnidade.contagens[indicePeriodo - 1];
            const catalogo = getCatalogoPorData(catalogoFull, atual.data);
            
            // Chave de período: DATA_ANTERIOR_DATA_ATUAL
            const keyPeriodo = `${anterior.data}_${atual.data}`;
            
            const vendas = dadosUnidade.vendas[keyPeriodo] || {};
            const entradas = dadosUnidade.entradas[keyPeriodo] || {};

            let perdaFinanceira = 0;
            let vendaFinanceira = 0;
            let valorEstoqueAtual = 0;
            let custoTotalVendas = 0;
            let margemTotal = 0;
            let itensDetalhados = [];

            Object.keys(catalogo).forEach(id => {
                const prod = catalogo[id];
                
                if (categoriaFilter !== 'TODAS' && prod.categoria !== categoriaFilter) return;

                const { custo, venda } = getPrecosFilial(prod, nomeFilialKey);

                const qtdInicial = anterior.itens[id] || 0;
                const qtdVendida = vendas[id] || 0;
                const qtdEntrada = entradas[id] || 0;
                const qtdFinal = atual.itens[id] || 0;
                
                const teorico = (qtdInicial + qtdEntrada) - qtdVendida;
                const diferenca = qtdFinal - teorico;
                
                let impactoFinanceiro = 0;
                // Considera perda apenas se diferença negativa
                if (diferenca < 0) {
                    impactoFinanceiro = Math.abs(diferenca * custo);
                    perdaFinanceira += impactoFinanceiro;
                }

                const receitaItem = qtdVendida * venda;
                const custoItemTotal = qtdVendida * custo;
                
                vendaFinanceira += receitaItem;
                custoTotalVendas += custoItemTotal;
                margemTotal += (receitaItem - custoItemTotal);
                valorEstoqueAtual += (qtdFinal * custo);

                // Giro e Sugestão
                const diasNoPeriodo = 7; 
                const vendaDiaria = qtdVendida / diasNoPeriodo;
                let diasCobertura = 0;
                let statusGiro = 'normal';
                
                if (vendaDiaria > 0) {
                    diasCobertura = qtdFinal / vendaDiaria;
                    if (diasCobertura > 45) statusGiro = 'lento'; 
                    if (diasCobertura < 3) statusGiro = 'critico'; 
                } else if (qtdFinal > 0) {
                    diasCobertura = 999;
                    statusGiro = 'morto';
                }

                let sugestaoCompra = 0;
                if (diasCobertura < 7 && vendaDiaria > 0) {
                    sugestaoCompra = Math.ceil((14 * vendaDiaria) - qtdFinal);
                }

                let curvaABC = 'C';
                if (venda > 20) curvaABC = 'A';
                else if (venda > 8) curvaABC = 'B';

                // Status Item
                let status = 'ok';
                if (diferenca < 0) status = 'atencao';
                if (impactoFinanceiro > 20) status = 'critico';

                itensDetalhados.push({
                    id,
                    nome: prod.nome,
                    categoria: prod.categoria,
                    custo,
                    inicial: qtdInicial,
                    vendas: qtdVendida,
                    entrada: qtdEntrada,
                    teorico,
                    final: qtdFinal,
                    diferenca,
                    perdaFinanceira: diferenca < 0 ? diferenca * custo : 0, // Negativo
                    perdaAbsoluta: diferenca < 0 ? Math.abs(diferenca * custo) : 0, // Positivo (Visual)
                    status,
                    diasCobertura,
                    statusGiro,
                    sugestaoCompra,
                    margemContrib: receitaItem - custoItemTotal,
                    curvaABC
                });
            });

            const itensCorretos = itensDetalhados.filter(i => i.diferenca === 0).length;
            const acuracidade = (itensDetalhados.length > 0) ? (itensCorretos / itensDetalhados.length) * 100 : 100;

            return {
                periodoLabel: formatDate(atual.data),
                dataFull: atual.data,
                observacoes: atual.observacoes || null,
                perdaFinanceira,
                vendaFinanceira,
                percentualPerda: vendaFinanceira > 0 ? (perdaFinanceira / vendaFinanceira) * 100 : 0,
                valorEstoqueAtual,
                acuracidade,
                margemTotal,
                detalhes: itensDetalhados
            };
        };

        // --- APP PRINCIPAL ---

        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [unidadeAtual, setUnidadeAtual] = useState('TODAS');
            const [categoriaSelecionada, setCategoriaSelecionada] = useState('TODAS');
            const [periodoSelecionado, setPeriodoSelecionado] = useState(0);
            const [activeTab, setActiveTab] = useState('visao_geral');
            
            // Tema
            const [theme, setTheme] = useState('system');
            const [isDark, setIsDark] = useState(false);
            useEffect(() => {
                const check = () => window.matchMedia('(prefers-color-scheme: dark)').matches;
                setIsDark(theme === 'system' ? check() : theme === 'dark');
            }, [theme]);

            // Hook de Dados Reais
            const { dadosBI, loading, error, catalogoFull } = useDadosReais(unidadeAtual, categoriaSelecionada);

            // Categorias Disponíveis
            const categoriasDisponiveis = useMemo(() => {
                if (!catalogoFull) return ["TODAS"];
                const cats = new Set();
                const latestKey = Object.keys(catalogoFull).sort().reverse()[0];
                const catalogo = catalogoFull[latestKey];
                Object.values(catalogo).forEach(p => cats.add(p.categoria));
                return ["TODAS", ...Array.from(cats)];
            }, [catalogoFull]);

            // Dados Computados
            const dadosAtuais = useMemo(() => {
                if (dadosBI?.tipo === 'INDIVIDUAL' && dadosBI.unidade && catalogoFull) {
                    const maxIdx = dadosBI.unidade.contagens.length - 1;
                    const idx = periodoSelecionado > maxIdx ? maxIdx : periodoSelecionado;
                    return calcularKPIsUnidade(dadosBI.unidade, idx || maxIdx, categoriaSelecionada, dadosBI.key, catalogoFull);
                }
                return null;
            }, [dadosBI, periodoSelecionado, categoriaSelecionada, catalogoFull]);

            const dadosEvolucao = useMemo(() => {
                if (dadosBI?.tipo === 'INDIVIDUAL' && dadosBI.unidade && catalogoFull) {
                    const dados = [];
                    for (let i = 1; i < dadosBI.unidade.contagens.length; i++) {
                        const calculo = calcularKPIsUnidade(dadosBI.unidade, i, categoriaSelecionada, dadosBI.key, catalogoFull);
                        if (calculo) {
                            dados.push({
                                name: calculo.periodoLabel,
                                Vendas: calculo.vendaFinanceira,
                                Perdas: calculo.perdaFinanceira, // Total já calculado
                                Percentual: parseFloat(calculo.percentualPerda.toFixed(1))
                            });
                        }
                    }
                    return dados;
                }
                return [];
            }, [dadosBI, categoriaSelecionada, catalogoFull]);

            const dadosConsolidados = useMemo(() => {
                if (dadosBI?.tipo === 'CONSOLIDADO') {
                    const datas = dadosBI.filiais.map(f => f.dataRef).sort();
                    const ultimaData = datas.length ? datas[datas.length - 1] : 'N/A';
                    
                    // Filtrar filiais com dados válidos
                    const filiaisValidas = dadosBI.filiais.filter(f => f.dados);

                    return {
                        dataReferencia: ultimaData,
                        rankingPerda: filiaisValidas.map(f => ({
                            name: f.nome.split(' ')[0],
                            perda: f.dados.perdaFinanceira,
                            venda: f.dados.vendaFinanceira
                        })).sort((a, b) => b.perda - a.perda),
                        
                        rankingEficiencia: filiaisValidas.map(f => ({
                            name: f.nome.split(' ')[0],
                            acuracidade: f.dados.acuracidade
                        })).sort((a, b) => b.acuracidade - a.acuracidade),
                        
                        totalGeralPerda: filiaisValidas.reduce((acc, curr) => acc + curr.dados.perdaFinanceira, 0),
                        totalGeralVenda: filiaisValidas.reduce((acc, curr) => acc + curr.dados.vendaFinanceira, 0),
                        totalGeralEstoque: filiaisValidas.reduce((acc, curr) => acc + curr.dados.valorEstoqueAtual, 0),
                    };
                }
                return null;
            }, [dadosBI]);

            const totaisTabela = useMemo(() => {
                if (!dadosAtuais) return null;
                return dadosAtuais.detalhes.reduce((acc, item) => {
                    acc.inicial += item.inicial;
                    acc.entrada += (item.entrada || 0);
                    acc.vendas += item.vendas;
                    acc.teorico += item.teorico;
                    acc.final += item.final;
                    acc.diferenca += item.diferenca;
                    acc.perdaFinanceira += item.perdaFinanceira; 
                    acc.margemContrib += item.margemContrib;
                    return acc;
                }, { inicial: 0, entrada: 0, vendas: 0, teorico: 0, final: 0, diferenca: 0, perdaFinanceira: 0, margemContrib: 0 });
            }, [dadosAtuais]);

            // --- RENDER ---

            if (!isAuthenticated) return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;

            return (
                <div className={`min-h-screen font-sans transition-colors duration-300 ${isDark ? 'bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
                    
                    {/* Top Bar */}
                    <div className={`px-6 py-3 flex justify-between items-center shadow-md transition-colors ${isDark ? 'bg-slate-950 text-white' : 'bg-slate-900 text-white'}`}>
                        <div className="flex items-center gap-3">
                            <Building2 size={18} className="text-blue-400" />
                            <div>
                                <div className="text-xs font-bold tracking-widest text-blue-200">CARATININGA LTDA</div>
                                <div className="text-sm font-semibold">Intelligence Dashboard</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-4 text-xs">
                            <button onClick={() => setTheme(prev => prev === 'dark' ? 'light' : 'dark')} className="p-1.5 rounded-full hover:bg-slate-700 transition-colors" title="Tema">
                                {isDark ? <Sun size={16} /> : <Moon size={16} />}
                            </button>
                            <div className="hidden md:flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Online</div>
                            <button onClick={() => setIsAuthenticated(false)} className="hover:text-red-300 transition-colors">Sair</button>
                        </div>
                    </div>

                    {/* Controls */}
                    <header className={`border-b sticky top-0 z-30 px-6 py-4 shadow-sm transition-colors ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                        <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 max-w-7xl mx-auto">
                            <div className="flex flex-col md:flex-row gap-4 w-full xl:w-auto">
                                
                                {/* Unidade */}
                                <div className="flex flex-col gap-1 w-full md:w-auto">
                                    <label className="text-[10px] font-bold uppercase flex items-center gap-1 opacity-60"><MapPin size={10} /> Escopo</label>
                                    <select 
                                        value={unidadeAtual}
                                        onChange={(e) => { setUnidadeAtual(e.target.value); setPeriodoSelecionado(0); }}
                                        className={`font-bold text-lg py-2 pl-3 pr-10 rounded-lg outline-none cursor-pointer w-full md:w-auto md:min-w-[280px] appearance-none ${isDark ? 'bg-slate-700 text-white' : 'bg-slate-100 text-slate-800'}`}
                                    >
                                        <option value="TODAS">TODAS AS UNIDADES</option>
                                        <option disabled>──────────────</option>
                                        {Object.keys(FILIAIS_CONFIG).map((key) => <option key={key} value={key}>{FILIAIS_CONFIG[key].nome}</option>)}
                                    </select>
                                </div>

                                {/* Categoria */}
                                <div className="flex flex-col gap-1 w-full md:w-auto">
                                    <label className="text-[10px] font-bold uppercase flex items-center gap-1 opacity-60"><Filter size={10} /> Categoria</label>
                                    <select 
                                        value={categoriaSelecionada}
                                        onChange={(e) => setCategoriaSelecionada(e.target.value)}
                                        className={`border font-medium text-sm py-2 px-3 rounded-lg outline-none cursor-pointer w-full md:w-48 ${isDark ? 'bg-slate-700 border-slate-600 text-white' : 'bg-white border-slate-200 text-slate-700'}`}
                                    >
                                        {categoriasDisponiveis.map(cat => <option key={cat} value={cat}>{cat === 'TODAS' ? 'Todas as Bebidas' : cat}</option>)}
                                    </select>
                                </div>

                                {/* Período */}
                                {unidadeAtual !== 'TODAS' && dadosBI?.unidade?.contagens && (
                                    <div className="flex flex-col gap-1 w-full md:w-auto">
                                        <label className="text-[10px] font-bold uppercase flex items-center gap-1 opacity-60"><Calendar size={10} /> Período</label>
                                        <select 
                                            value={periodoSelecionado} 
                                            onChange={(e) => setPeriodoSelecionado(Number(e.target.value))}
                                            className={`border font-medium text-sm py-2 px-3 rounded-lg outline-none cursor-pointer w-full md:w-48 ${isDark ? 'bg-slate-700 border-slate-600 text-white' : 'bg-white border-slate-200 text-slate-700'}`}
                                        >
                                            {dadosBI.unidade.contagens.map((c, idx) => idx > 0 && <option key={c.id} value={idx}>Inv. {formatDate(c.data)}</option>)}
                                        </select>
                                    </div>
                                )}
                            </div>

                            {/* Tabs */}
                            {unidadeAtual !== 'TODAS' && (
                                <div className={`flex p-1 rounded-lg w-full xl:w-auto overflow-x-auto ${isDark ? 'bg-slate-700' : 'bg-slate-100'}`}>
                                    {['visao_geral', 'graficos', 'tabela'].map(tab => (
                                        <button 
                                            key={tab} onClick={() => setActiveTab(tab)}
                                            className={`flex-1 px-4 py-2 text-xs font-bold rounded-md transition-all flex items-center gap-2 justify-center whitespace-nowrap ${activeTab === tab ? (isDark ? 'bg-slate-600 text-blue-400 shadow-sm' : 'bg-white text-blue-600 shadow-sm') : (isDark ? 'text-slate-400 hover:text-white' : 'text-slate-500 hover:text-slate-700')}`}
                                        >
                                            {tab === 'visao_geral' && <Activity size={14} />}
                                            {tab === 'graficos' && <BarChart3 size={14} />}
                                            {tab === 'tabela' && <Table size={14} />}
                                            {tab.replace('_', ' ').toUpperCase()}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </header>

                    {/* Content */}
                    <main className="p-6 max-w-7xl mx-auto">
                        {loading && <div className="text-center py-20 opacity-50 animate-pulse">Carregando dados do servidor...</div>}
                        {error && <div className="text-center py-20 text-red-500 font-bold">{error}</div>}
                        
                        {!loading && !error && unidadeAtual === 'TODAS' && dadosConsolidados && (
                            <div className="animate-in slide-in-from-bottom-4 duration-500">
                                <div className="mb-6 flex items-center gap-2 opacity-80"><Building2 /><h2 className="text-xl font-bold">Visão Consolidada</h2></div>
                                {/* Cards Macro */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div className={`p-6 rounded-2xl border shadow-sm ${isDark ? 'bg-slate-800 border-red-900/50' : 'bg-gradient-to-br from-red-50 to-white border-red-100'}`}>
                                        <div className={`text-xs font-bold uppercase mb-2 flex items-center gap-2 ${isDark ? 'text-red-400' : 'text-red-800'}`}><TrendingDown size={14} /> Perda Total</div>
                                        <div className="text-4xl font-black text-red-600 mb-1">-{formatCurrency(dadosConsolidados.totalGeralPerda)}</div>
                                        <div className="text-xs opacity-60">Ref: {dadosConsolidados.dataReferencia}</div>
                                    </div>
                                    <div className={`p-6 rounded-2xl border shadow-sm ${isDark ? 'bg-slate-800 border-blue-900/50' : 'bg-gradient-to-br from-blue-50 to-white border-blue-100'}`}>
                                        <div className={`text-xs font-bold uppercase mb-2 flex items-center gap-2 ${isDark ? 'text-blue-400' : 'text-blue-800'}`}><DollarSign size={14} /> Valor Estoque</div>
                                        <div className="text-4xl font-black text-blue-600 mb-1">{formatCurrency(dadosConsolidados.totalGeralEstoque)}</div>
                                    </div>
                                    <div className={`p-6 rounded-2xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-gradient-to-br from-slate-50 to-white border-slate-200'}`}>
                                        <div className={`text-xs font-bold uppercase mb-2 flex items-center gap-2 ${isDark ? 'text-slate-400' : 'text-slate-600'}`}><ShoppingCart size={14} /> Vendas Totais</div>
                                        <div className={`text-4xl font-black mb-1 ${isDark ? 'text-slate-200' : 'text-slate-700'}`}>{formatCurrency(dadosConsolidados.totalGeralVenda)}</div>
                                    </div>
                                </div>
                                {/* Gráficos Comparativos */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className={`p-6 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                        <h3 className="text-lg font-bold mb-4">Ranking de Prejuízo (R$)</h3>
                                        <div className="h-72">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={dadosConsolidados.rankingPerda} layout="vertical" margin={{left: 20, right: 30}}>
                                                    <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} stroke={isDark ? '#334155' : '#e2e8f0'} />
                                                    <XAxis type="number" hide />
                                                    <YAxis dataKey="name" type="category" width={100} tick={{fontWeight: 'bold', fill: isDark ? '#94a3b8' : '#334155'}} />
                                                    <Tooltip formatter={(v) => formatCurrency(v)} contentStyle={{backgroundColor: isDark ? '#0f172a' : '#fff'}} />
                                                    <Bar dataKey="perda" fill="#ef4444" radius={[0,4,4,0]} barSize={30}>
                                                        <LabelList dataKey="perda" position="right" formatter={(v) => formatCurrency(v)} fill={isDark ? '#fff' : '#000'} fontSize={10} />
                                                    </Bar>
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                    <div className={`p-6 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                        <h3 className="text-lg font-bold mb-4">Benchmarking: Acuracidade</h3>
                                        <div className="h-72">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={dadosConsolidados.rankingEficiencia} layout="vertical" margin={{left: 20}}>
                                                    <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} stroke={isDark ? '#334155' : '#e2e8f0'} />
                                                    <XAxis type="number" domain={[0, 100]} hide />
                                                    <YAxis dataKey="name" type="category" width={100} tick={{fontWeight: 'bold', fill: isDark ? '#94a3b8' : '#334155'}} />
                                                    <Tooltip formatter={(v) => `${v.toFixed(1)}%`} contentStyle={{backgroundColor: isDark ? '#0f172a' : '#fff'}} />
                                                    <Bar dataKey="acuracidade" fill="#3b82f6" radius={[0,4,4,0]} barSize={30} />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {!loading && !error && unidadeAtual !== 'TODAS' && dadosAtuais && (
                            <div className="animate-in slide-in-from-bottom-4 duration-500">
                                {dadosAtuais.observacoes && (
                                    <div className={`mb-6 border p-4 rounded-lg flex items-start gap-3 ${isDark ? 'bg-amber-900/30 border-amber-800' : 'bg-amber-50 border-amber-200'}`}>
                                        <Info className="text-amber-600 shrink-0 mt-0.5" size={20} />
                                        <div>
                                            <h4 className={`font-bold text-sm ${isDark ? 'text-amber-400' : 'text-amber-800'}`}>Ocorrência Operacional</h4>
                                            <p className={`text-sm ${isDark ? 'text-amber-200' : 'text-amber-700'}`}>{dadosAtuais.observacoes}</p>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'visao_geral' && (
                                    <>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                            <div className={`p-5 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <div className="flex justify-between items-start mb-2"><div className="text-xs font-bold uppercase opacity-60">Perda Financeira</div><TrendingDown size={16} className="text-red-500" /></div>
                                                <div className={`text-2xl font-black ${isDark ? 'text-slate-100' : 'text-slate-800'}`}>-{formatCurrency(dadosAtuais.perdaFinanceira)}</div>
                                            </div>
                                            <div className={`p-5 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <div className="flex justify-between items-start mb-2"><div className="text-xs font-bold uppercase opacity-60">Valor Estoque</div><DollarSign size={16} className="text-blue-500" /></div>
                                                <div className={`text-2xl font-black ${isDark ? 'text-slate-100' : 'text-slate-800'}`}>{formatCurrency(dadosAtuais.valorEstoqueAtual)}</div>
                                            </div>
                                            <div className={`p-5 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <div className="flex justify-between items-start mb-2"><div className="text-xs font-bold uppercase opacity-60">Margem</div><TrendingUp size={16} className="text-green-500" /></div>
                                                <div className={`text-2xl font-black ${isDark ? 'text-slate-100' : 'text-slate-800'}`}>{formatCurrency(dadosAtuais.margemTotal)}</div>
                                            </div>
                                            <div className={`p-5 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <div className="flex justify-between items-start mb-2"><div className="text-xs font-bold uppercase opacity-60">Acuracidade</div><CheckCircle size={16} className="text-purple-500" /></div>
                                                <div className={`text-2xl font-black ${isDark ? 'text-slate-100' : 'text-slate-800'}`}>{dadosAtuais.acuracidade.toFixed(1)}%</div>
                                            </div>
                                        </div>

                                        <div className={`p-6 rounded-xl border shadow-sm mb-6 ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                            <h3 className="text-lg font-bold mb-6 flex items-center gap-2"><TrendingUp size={20} className="text-blue-500" /> Evolução</h3>
                                            <div className="h-80 w-full">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <ComposedChart data={dadosEvolucao}>
                                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={isDark ? '#334155' : '#f1f5f9'} />
                                                        <XAxis dataKey="name" tick={{fontSize: 12, fill: isDark ? '#94a3b8' : '#64748b'}} tickLine={false} axisLine={false} dy={10} />
                                                        <YAxis yAxisId="left" orientation="left" stroke="#3b82f6" tickFormatter={(v) => `R$${v}`} tickLine={false} axisLine={false} />
                                                        <YAxis yAxisId="right" orientation="right" stroke="#ef4444" tickFormatter={(v) => `R$${v}`} tickLine={false} axisLine={false} />
                                                        <Tooltip formatter={(value, name) => [formatCurrency(Number(value)), name === "Perdas" ? "Prejuízo" : "Vendas"]} contentStyle={{backgroundColor: isDark ? '#0f172a' : '#fff'}} />
                                                        <Legend iconType="circle" />
                                                        <Bar yAxisId="left" dataKey="Vendas" fill="#3b82f6" radius={[4, 4, 0, 0]} name="Vendas" barSize={50} />
                                                        <Line yAxisId="right" type="monotone" dataKey="Perdas" stroke="#ef4444" strokeWidth={3} dot={{r: 4}} name="Perdas" />
                                                    </ComposedChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeTab === 'graficos' && (
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className={`p-6 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                            <h3 className="text-lg font-bold mb-2">Curva ABC</h3>
                                            <div className="h-64">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie 
                                                            data={[
                                                                {name: 'Classe A', value: dadosAtuais.detalhes.filter(i=>i.curvaABC==='A').length},
                                                                {name: 'Classe B', value: dadosAtuais.detalhes.filter(i=>i.curvaABC==='B').length},
                                                                {name: 'Classe C', value: dadosAtuais.detalhes.filter(i=>i.curvaABC==='C').length}
                                                            ]} 
                                                            innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value"
                                                            label={({name, percent}) => `${name} ${(percent * 100).toFixed(0)}%`}
                                                        >
                                                            <Cell fill="#3b82f6" /><Cell fill="#f59e0b" /><Cell fill="#94a3b8" />
                                                        </Pie>
                                                        <Tooltip />
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                        <div className={`p-6 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                            <h3 className="text-lg font-bold mb-2">Top 5 Prejuízo</h3>
                                            <div className="h-64">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <BarChart layout="vertical" data={[...dadosAtuais.detalhes].filter(d=>d.perdaFinanceira<0).sort((a,b)=>a.perdaFinanceira-b.perdaFinanceira).slice(0,5)} margin={{left: 20, right: 30}}>
                                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} stroke={isDark ? '#334155' : '#e2e8f0'} />
                                                        <XAxis type="number" hide />
                                                        <YAxis type="category" dataKey="nome" width={100} tick={{fontSize: 10, fill: isDark ? '#94a3b8' : '#64748b'}} />
                                                        <Tooltip formatter={(v) => formatCurrency(Number(v))} contentStyle={{backgroundColor: isDark ? '#0f172a' : '#fff'}} />
                                                        <Bar dataKey="perdaAbsoluta" fill="#ef4444" radius={[0,4,4,0]} barSize={24} name="Perda">
                                                            <LabelList dataKey="perdaAbsoluta" position="right" formatter={(v) => formatCurrency(v)} fill={isDark ? '#fff' : '#000'} fontSize={10} />
                                                        </Bar>
                                                    </BarChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'tabela' && (
                                    <div className={`rounded-xl shadow-sm border overflow-hidden ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className={`font-semibold border-b whitespace-nowrap ${isDark ? 'bg-slate-900 text-slate-400 border-slate-700' : 'bg-slate-50 text-slate-500 border-slate-200'}`}>
                                                    <tr>
                                                        <th className="px-4 py-3">Produto</th>
                                                        <th className="px-4 py-3 text-center">Anterior</th>
                                                        <th className="px-4 py-3 text-center text-green-600">(+) Ent.</th>
                                                        <th className="px-4 py-3 text-center text-red-400">(-) Sai.</th>
                                                        <th className="px-4 py-3 text-center text-blue-500">(=) Teórico</th>
                                                        <th className="px-4 py-3 text-center bg-slate-100 dark:bg-slate-700/50">Atual</th>
                                                        <th className="px-4 py-3 text-center">Dif.</th>
                                                        <th className="px-4 py-3 text-right">Perda R$</th>
                                                        <th className="px-4 py-3 text-center">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                                                    {dadosAtuais.detalhes.map((item) => (
                                                        <tr key={item.id} className={`transition-colors ${isDark ? 'hover:bg-slate-700' : 'hover:bg-slate-50'}`}>
                                                            <td className="px-4 py-3 font-medium">{item.nome}</td>
                                                            <td className="px-4 py-3 text-center opacity-70">{item.inicial}</td>
                                                            <td className="px-4 py-3 text-center text-green-600">{item.entrada || '-'}</td>
                                                            <td className="px-4 py-3 text-center text-red-400">{item.vendas}</td>
                                                            <td className="px-4 py-3 text-center font-bold text-blue-500">{item.teorico}</td>
                                                            <td className="px-4 py-3 text-center font-bold bg-slate-50 dark:bg-slate-800">{item.final}</td>
                                                            <td className={`px-4 py-3 text-center font-bold ${item.diferenca < 0 ? 'text-red-500' : 'text-green-500'}`}>{item.diferenca}</td>
                                                            <td className="px-4 py-3 text-right font-medium text-red-500">{item.perdaFinanceira < 0 ? formatCurrency(item.perdaAbsoluta) : '-'}</td>
                                                            <td className="px-4 py-3 text-center"><StatusBadge type={item.status} text={item.status} /></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                                {totaisTabela && (
                                                    <tfoot className={`font-bold ${isDark ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-800'}`}>
                                                        <tr>
                                                            <td className="px-4 py-3 text-right">TOTAIS:</td>
                                                            <td className="px-4 py-3 text-center">{totaisTabela.inicial}</td>
                                                            <td className="px-4 py-3 text-center text-green-600">{totaisTabela.entrada}</td>
                                                            <td className="px-4 py-3 text-center text-red-400">{totaisTabela.vendas}</td>
                                                            <td className="px-4 py-3 text-center text-blue-500">{totaisTabela.teorico}</td>
                                                            <td className="px-4 py-3 text-center">{totaisTabela.final}</td>
                                                            <td className={`px-4 py-3 text-center ${totaisTabela.diferenca < 0 ? 'text-red-500' : 'text-green-500'}`}>{totaisTabela.diferenca}</td>
                                                            <td className="px-4 py-3 text-right text-red-500">{formatCurrency(Math.abs(totaisTabela.perdaFinanceira))}</td>
                                                            <td></td>
                                                        </tr>
                                                    </tfoot>
                                                )}
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
