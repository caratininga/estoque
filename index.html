<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Estoque Caratininga</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Prop-Types -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Estilos de Impressão */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; color: black !important; background: white !important; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        // --- RECHARTS SAFE ACCESS ---
        const RechartsObj = window.Recharts || {};
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
            PieChart, Pie, Cell, ComposedChart, Line, LabelList
        } = RechartsObj;
        const chartsAvailable = !!(BarChart && PieChart && ComposedChart);
        const SafeChart = ({ children }) => chartsAvailable ? children : <div className="flex items-center justify-center h-full text-gray-400 text-sm">Gráfico indisponível</div>;

        // --- ICON SYSTEM (INLINE SVG) ---
        const IconBase = ({ children, className, size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Icons = {
            Building2: (p) => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>,
            TrendingDown: (p) => <IconBase {...p}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></IconBase>,
            DollarSign: (p) => <IconBase {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>,
            ShoppingCart: (p) => <IconBase {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconBase>,
            Activity: (p) => <IconBase {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>,
            BarChart3: (p) => <IconBase {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>,
            Table: (p) => <IconBase {...p}><path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/></IconBase>,
            Filter: (p) => <IconBase {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>,
            Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            MapPin: (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            Sun: (p) => <IconBase {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>,
            Moon: (p) => <IconBase {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>,
            Printer: (p) => <IconBase {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            Info: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            TrendingUp: (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>,
            PackageX: (p) => <IconBase {...p}><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"/><path d="m7.5 4.27 9 5.15"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/><path d="m17 13 5 5m-5 0 5-5"/></IconBase>,
            Truck: (p) => <IconBase {...p}><path d="M14 18V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></IconBase>,
            ArrowUp: (p) => <IconBase {...p}><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></IconBase>,
            ArrowDown: (p) => <IconBase {...p}><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></IconBase>,
            ArrowUpDown: (p) => <IconBase {...p}><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></IconBase>,
            FileX: (p) => <IconBase {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m14.5 12.5-5 5"/><path d="m9.5 12.5 5 5"/></IconBase>,
            AlertCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>
        };

        // --- UTILITÁRIOS ---
        const formatCurrency = (val) => new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR' }).format(val);
        const formatDate = (dateStr) => {
            if (!dateStr) return "-";
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}`;
        };

        // --- COMPONENTES ---
        const StatusBadge = ({ type, text }) => {
            const colors = {
                critico: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100',
                atencao: 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-100',
                ok: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100',
                morto: 'bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-300',
                lento: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100'
            };
            return <span className={`px-2 py-1 rounded text-xs font-bold ${colors[type] || colors.ok}`}>{text}</span>;
        };

        const SortIcon = ({ active, direction }) => {
            if (!active) return <Icons.ArrowUpDown size={14} className="ml-1 text-slate-400 inline opacity-40" />;
            return direction === 'ascending' 
                ? <Icons.ArrowUp size={14} className="ml-1 text-blue-600 dark:text-blue-400 inline" /> 
                : <Icons.ArrowDown size={14} className="ml-1 text-blue-600 dark:text-blue-400 inline" />;
        };

        const LoginScreen = ({ onLogin }) => {
            const [pass, setPass] = useState("");
            const [error, setError] = useState(false);
            const handleSubmit = (e) => {
                e.preventDefault();
                if (pass === "1337") onLogin();
                else setError(true);
            };
            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
                        <div className="flex justify-center mb-6"><div className="bg-blue-100 p-3 rounded-full"><Icons.Lock className="text-blue-600 w-8 h-8" /></div></div>
                        <h2 className="text-2xl font-bold text-center text-slate-800 mb-2">Acesso Restrito</h2>
                        <p className="text-center text-slate-500 mb-6">Controle de Perdas Caratininga</p>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Senha de Acesso</label>
                                <input type="password" value={pass} onChange={(e) => { setPass(e.target.value); setError(false); }} className="w-full border border-slate-300 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all font-mono text-lg" placeholder="••••" autoFocus />
                            </div>
                            {error && <div className="text-red-500 text-sm font-medium flex items-center gap-2 bg-red-50 p-3 rounded-lg"><Icons.AlertCircle size={16} /> Senha incorreta.</div>}
                            <button type="submit" className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg transition-all active:scale-95">Entrar no Sistema</button>
                        </form>
                    </div>
                </div>
            );
        };

        const EmptyState = ({ message, isDark }) => (
            <div className={`flex flex-col items-center justify-center h-96 p-8 text-center rounded-xl border-2 border-dashed ${isDark ? 'border-slate-700 bg-slate-800/50' : 'border-slate-300 bg-slate-50'}`}>
                <div className={`p-4 rounded-full mb-4 ${isDark ? 'bg-slate-700 text-slate-400' : 'bg-slate-200 text-slate-500'}`}>
                    <Icons.FileX size={48} />
                </div>
                <h3 className={`text-xl font-bold mb-2 ${isDark ? 'text-slate-200' : 'text-slate-700'}`}>Nenhum dado encontrado</h3>
                <p className={`max-w-md mb-6 ${isDark ? 'text-slate-400' : 'text-slate-500'}`}>{message}</p>
                <div className={`text-xs p-3 rounded text-left font-mono ${isDark ? 'bg-slate-900 text-slate-400' : 'bg-slate-200 text-slate-600'}`}>
                    Dica: Verifique a estrutura da pasta 'data/' no repositório.
                </div>
            </div>
        );

        // --- DATA LOGIC ---
        const FILIAIS_CONFIG = {
            "GRACA": { nome: "Graça (Matriz)", path: "graca" },
            "MUCAMBO": { nome: "Mucambo (Filial)", path: "mucambo" },
            "FRECHEIRINHA": { nome: "Frecheirinha (Filial)", path: "frecheirinha" },
            "TIANGUA": { nome: "Tianguá (Filial)", path: "tiangua" }
        };

        const getCatalogoPorData = (catalogoFull, dataContagem) => {
            if (!catalogoFull) return {};
            const datasDisponiveis = Object.keys(catalogoFull).sort();
            const dataValida = datasDisponiveis.reverse().find(d => d <= dataContagem) || datasDisponiveis[0];
            return catalogoFull[dataValida] || {};
        };

        const getPrecosFilial = (produto, nomeFilial) => {
            if (!produto || !produto.filiais) return { custo: 0, venda: 0 };
            let dados = produto.filiais[nomeFilial];
            if (!dados || dados.custo === 0) dados = produto.filiais["GRACA"];
            if (!dados) return { custo: 0, venda: 0 };
            return { custo: dados.custo, venda: dados.preco_venda };
        };

        const calcularKPIsUnidade = (dadosUnidade, indicePeriodo, categoriaFilter, nomeFilialKey, catalogoFull) => {
            if (!dadosUnidade || !dadosUnidade.contagens || !dadosUnidade.contagens[indicePeriodo] || indicePeriodo === 0) return null;

            const atual = dadosUnidade.contagens[indicePeriodo];
            const anterior = dadosUnidade.contagens[indicePeriodo - 1];
            const catalogo = getCatalogoPorData(catalogoFull, atual.data);
            const keyPeriodo = `${anterior.data}_${atual.data}`;
            
            const vendas = dadosUnidade.vendas[keyPeriodo] || {};
            const entradas = dadosUnidade.entradas[keyPeriodo] || {};

            let perdaFinanceira = 0;
            let vendaFinanceira = 0;
            let valorEstoqueAtual = 0;
            let custoTotalVendas = 0;
            let margemTotal = 0;
            let itensDetalhados = [];

            Object.keys(catalogo).forEach(id => {
                const prod = catalogo[id];
                if (categoriaFilter !== 'TODAS' && prod.categoria !== categoriaFilter) return;

                const { custo, venda } = getPrecosFilial(prod, nomeFilialKey);
                const qtdInicial = anterior.itens[id] || 0;
                const qtdVendida = vendas[id] || 0;
                const qtdEntrada = entradas[id] || 0;
                const qtdFinal = atual.itens[id] || 0;
                const teorico = (qtdInicial + qtdEntrada) - qtdVendida;
                const diferenca = qtdFinal - teorico;
                
                let impactoFinanceiro = 0;
                if (diferenca < 0) {
                    impactoFinanceiro = Math.abs(diferenca * custo);
                    perdaFinanceira += impactoFinanceiro;
                }

                const receitaItem = qtdVendida * venda;
                const custoItemTotal = qtdVendida * custo;
                vendaFinanceira += receitaItem;
                custoTotalVendas += custoItemTotal;
                margemTotal += (receitaItem - custoItemTotal);
                valorEstoqueAtual += (qtdFinal * custo);

                const diasNoPeriodo = 7; 
                const vendaDiaria = qtdVendida / diasNoPeriodo;
                let diasCobertura = 0;
                let statusGiro = 'normal';
                
                if (vendaDiaria > 0) {
                    diasCobertura = qtdFinal / vendaDiaria;
                    if (diasCobertura > 45) statusGiro = 'lento'; 
                    if (diasCobertura < 3) statusGiro = 'critico'; 
                } else if (qtdFinal > 0) {
                    diasCobertura = 999;
                    statusGiro = 'morto';
                }

                let sugestaoCompra = 0;
                if (diasCobertura < 7 && vendaDiaria > 0) sugestaoCompra = Math.ceil((14 * vendaDiaria) - qtdFinal);

                let curvaABC = 'C';
                if (venda > 20) curvaABC = 'A';
                else if (venda > 8) curvaABC = 'B';

                let status = 'ok';
                if (diferenca < 0) status = 'atencao';
                if (impactoFinanceiro > 20) status = 'critico';

                itensDetalhados.push({
                    id, nome: prod.nome, categoria: prod.categoria, custo,
                    inicial: qtdInicial, vendas: qtdVendida, entrada: qtdEntrada,
                    teorico: parseFloat(teorico.toFixed(2)), final: qtdFinal, diferenca: parseFloat(diferenca.toFixed(2)),
                    perdaFinanceira: diferenca < 0 ? diferenca * custo : 0, 
                    perdaAbsoluta: diferenca < 0 ? Math.abs(diferenca * custo) : 0,
                    status, diasCobertura, statusGiro, sugestaoCompra, margemContrib: receitaItem - custoItemTotal, curvaABC
                });
            });

            const itensCorretos = itensDetalhados.filter(i => i.diferenca === 0).length;
            const acuracidade = (itensDetalhados.length > 0) ? (itensCorretos / itensDetalhados.length) * 100 : 100;

            return {
                periodoLabel: formatDate(atual.data),
                dataFull: atual.data,
                observacoes: atual.observacoes || null,
                perdaFinanceira, vendaFinanceira, percentualPerda: vendaFinanceira > 0 ? (perdaFinanceira / vendaFinanceira) * 100 : 0,
                valorEstoqueAtual, acuracidade, margemTotal, detalhes: itensDetalhados
            };
        };

        const useDadosReais = (unidadeSelecionada, categoriaFilter) => {
            const [dados, setDados] = useState(null);
            const [catalogo, setCatalogo] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const safeFetch = async (url) => {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("Erro na resposta");
                    return await res.json();
                } catch (e) {
                    console.warn(`Fetch falhou para: ${url}`, e);
                    return null; 
                }
            };

            useEffect(() => {
                const loadCatalogo = async () => {
                    const data = await safeFetch('data/catalogo.json');
                    if (data) setCatalogo(data);
                    else {
                        setLoading(false);
                        setError("Catálogo não encontrado.");
                    }
                };
                loadCatalogo();
            }, []);

            useEffect(() => {
                if (!catalogo) return;

                const carregarDados = async () => {
                    setLoading(true);
                    setError(null);
                    
                    try {
                        if (unidadeSelecionada === 'TODAS') {
                            const promises = Object.keys(FILIAIS_CONFIG).map(async (key) => {
                                const config = FILIAIS_CONFIG[key];
                                const contagens = await safeFetch(`data/${config.path}/contagens.json`) || [];
                                const vendas = await safeFetch(`data/${config.path}/vendas.json`) || {};
                                const entradas = await safeFetch(`data/${config.path}/entradas.json`) || {};
                                
                                const unidadeDados = { contagens, vendas, entradas };
                                if(!contagens || contagens.length < 2) return { nome: config.nome, dados: null };

                                const ultimoPeriodo = contagens.length - 1;
                                const kpis = calcularKPIsUnidade(unidadeDados, ultimoPeriodo, categoriaFilter, key, catalogo);
                                
                                return { nome: config.nome, dataRef: kpis ? kpis.periodoLabel : 'N/A', dados: kpis };
                            });

                            const resultados = await Promise.all(promises);
                            const validos = resultados.filter(r => r.dados !== null);
                            
                            if (validos.length === 0) throw new Error("Nenhum dado válido encontrado.");
                            setDados({ tipo: 'CONSOLIDADO', filiais: resultados });

                        } else {
                            const config = FILIAIS_CONFIG[unidadeSelecionada];
                            const contagens = await safeFetch(`data/${config.path}/contagens.json`);
                            const vendas = await safeFetch(`data/${config.path}/vendas.json`) || {};
                            const entradas = await safeFetch(`data/${config.path}/entradas.json`) || {};

                            if(!contagens || contagens.length === 0) throw new Error("Arquivo de contagens não encontrado.");

                            setDados({ tipo: 'INDIVIDUAL', unidade: { contagens, vendas, entradas }, key: unidadeSelecionada });
                        }
                    } catch (err) {
                        console.error("Erro:", err);
                        setError("Não foi possível carregar os dados.");
                        setDados(null);
                    } finally {
                        setLoading(false);
                    }
                };

                carregarDados();
            }, [unidadeSelecionada, categoriaFilter, catalogo]);

            return { dadosBI: dados, loading, error, catalogoFull: catalogo };
        };

        // --- APP ---
        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [unidadeAtual, setUnidadeAtual] = useState('TODAS');
            const [categoriaSelecionada, setCategoriaSelecionada] = useState('TODAS');
            const [periodoSelecionado, setPeriodoSelecionado] = useState(0);
            const [activeTab, setActiveTab] = useState('visao_geral');
            const [theme, setTheme] = useState('system');
            const [isDark, setIsDark] = useState(false);
            
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'ascending' });
            const [showFichaModal, setShowFichaModal] = useState(false);
            const [fichaCategoria, setFichaCategoria] = useState('TODAS');

            useEffect(() => {
                const check = () => window.matchMedia('(prefers-color-scheme: dark)').matches;
                setIsDark(theme === 'system' ? check() : theme === 'dark');
            }, [theme]);

            const { dadosBI, loading, error, catalogoFull } = useDadosReais(unidadeAtual, categoriaSelecionada);

            const categoriasDisponiveis = useMemo(() => {
                if (!catalogoFull) return ["TODAS"];
                const cats = new Set();
                const latestKey = Object.keys(catalogoFull).sort().reverse()[0];
                const catalogo = catalogoFull[latestKey];
                Object.values(catalogo).forEach(p => cats.add(p.categoria));
                return ["TODAS", ...Array.from(cats)];
            }, [catalogoFull]);

            const dadosAtuais = useMemo(() => {
                if (dadosBI?.tipo === 'INDIVIDUAL' && dadosBI.unidade && catalogoFull) {
                    const maxIdx = dadosBI.unidade.contagens.length - 1;
                    const idx = periodoSelecionado > maxIdx ? maxIdx : periodoSelecionado;
                    return calcularKPIsUnidade(dadosBI.unidade, idx || maxIdx, categoriaSelecionada, dadosBI.key, catalogoFull);
                }
                return null;
            }, [dadosBI, periodoSelecionado, categoriaSelecionada, catalogoFull]);

            const dadosEvolucao = useMemo(() => {
                if (dadosBI?.tipo === 'INDIVIDUAL' && dadosBI.unidade && catalogoFull) {
                    const dados = [];
                    for (let i = 1; i < dadosBI.unidade.contagens.length; i++) {
                        const calculo = calcularKPIsUnidade(dadosBI.unidade, i, categoriaSelecionada, dadosBI.key, catalogoFull);
                        if (calculo) {
                            dados.push({ name: calculo.periodoLabel, Vendas: calculo.vendaFinanceira, Perdas: calculo.perdaFinanceira, Percentual: parseFloat(calculo.percentualPerda.toFixed(1)) });
                        }
                    }
                    return dados;
                }
                return [];
            }, [dadosBI, categoriaSelecionada, catalogoFull]);

            const dadosConsolidados = useMemo(() => {
                if (dadosBI?.tipo === 'CONSOLIDADO') {
                    const filiaisValidas = dadosBI.filiais.filter(f => f.dados);
                    if (filiaisValidas.length === 0) return null;
                    const ultimaData = filiaisValidas[0].dataRef;

                    return {
                        dataReferencia: ultimaData,
                        rankingPerda: filiaisValidas.map(f => ({ name: f.nome.split(' ')[0], perda: f.dados.perdaFinanceira, venda: f.dados.vendaFinanceira })).sort((a, b) => b.perda - a.perda),
                        rankingEficiencia: filiaisValidas.map(f => ({ name: f.nome.split(' ')[0], acuracidade: f.dados.acuracidade })).sort((a, b) => b.acuracidade - a.acuracidade),
                        totalGeralPerda: filiaisValidas.reduce((acc, curr) => acc + curr.dados.perdaFinanceira, 0),
                        totalGeralVenda: filiaisValidas.reduce((acc, curr) => acc + curr.dados.vendaFinanceira, 0),
                        totalGeralEstoque: filiaisValidas.reduce((acc, curr) => acc + curr.dados.valorEstoqueAtual, 0),
                    };
                }
                return null;
            }, [dadosBI]);

            const totaisTabela = useMemo(() => {
                if (!dadosAtuais) return null;
                return dadosAtuais.detalhes.reduce((acc, item) => {
                    acc.inicial += item.inicial; acc.entrada += (item.entrada || 0); acc.vendas += item.vendas;
                    acc.teorico += item.teorico; acc.final += item.final; acc.diferenca += item.diferenca;
                    acc.perdaFinanceira += item.perdaFinanceira; acc.margemContrib += item.margemContrib;
                    return acc;
                }, { inicial: 0, entrada: 0, vendas: 0, teorico: 0, final: 0, diferenca: 0, perdaFinanceira: 0, margemContrib: 0 });
            }, [dadosAtuais]);

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };

            const sortedItems = useMemo(() => {
                if (!dadosAtuais) return [];
                let sortableItems = [...dadosAtuais.detalhes];
                if (sortConfig.key !== null) {
                    sortableItems.sort((a, b) => {
                        let valA = a[sortConfig.key];
                        let valB = b[sortConfig.key];
                        if (typeof valA === 'string') valA = valA.toLowerCase();
                        if (typeof valB === 'string') valB = valB.toLowerCase();
                        if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
                        return 0;
                    });
                }
                return sortableItems;
            }, [dadosAtuais, sortConfig]);

            // Gerador de Ficha
            const gerarFichaContagem = () => {
                const win = window.open('', '_blank');
                
                if (!catalogoFull) return;
                const latestKey = Object.keys(catalogoFull).sort().reverse()[0];
                const catalogo = catalogoFull[latestKey];
                
                const produtosFiltrados = Object.keys(catalogo)
                    .map(key => catalogo[key])
                    .filter(p => fichaCategoria === 'TODAS' || p.categoria === fichaCategoria)
                    .sort((a, b) => a.nome.localeCompare(b.nome));

                const html = `
                    <html>
                    <head>
                        <title>Ficha de Contagem - ${fichaCategoria}</title>
                        <style>
                            body { font-family: Arial, sans-serif; font-size: 12px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                            th { background-color: #f0f0f0; }
                            .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                            @media print { .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div>
                                <h1>Ficha de Contagem de Estoque</h1>
                                <p><strong>Categoria:</strong> ${fichaCategoria === 'TODAS' ? 'Geral' : fichaCategoria}</p>
                                <p><strong>Data:</strong> ____/____/_______</p>
                                <p><strong>Responsável:</strong> ________________________</p>
                            </div>
                            <button class="no-print" onclick="window.print()" style="padding: 10px 20px; font-size: 14px; cursor: pointer;">IMPRIMIR FICHA</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 35%">Produto</th>
                                    <th style="width: 15%">Categoria</th>
                                    <th>Local 1</th>
                                    <th>Local 2</th>
                                    <th>Local 3</th>
                                    <th>Local 4</th>
                                    <th style="background-color: #e0e0e0">TOTAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${produtosFiltrados.map(p => `
                                    <tr>
                                        <td>${p.nome}</td>
                                        <td>${p.categoria}</td>
                                        <td></td><td></td><td></td><td></td>
                                        <td style="background-color: #f9f9f9"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;
                win.document.write(html);
                win.document.close();
                setShowFichaModal(false);
            };

            if (!isAuthenticated) return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;

            return (
                <div className={`min-h-screen font-sans transition-colors duration-300 ${isDark ? 'bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
                    
                    {/* Top Bar */}
                    <div className={`px-6 py-3 flex justify-between items-center shadow-md transition-colors ${isDark ? 'bg-slate-950 text-white' : 'bg-slate-900 text-white'}`}>
                        <div className="flex items-center gap-3">
                            <Icons.Building2 size={18} className="text-blue-400" />
                            <div>
                                <div className="text-xs font-bold tracking-widest text-blue-200">CARATININGA LTDA</div>
                                <div className="text-sm font-semibold">Intelligence Dashboard</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-4 text-xs">
                            <button onClick={() => setTheme(prev => prev === 'dark' ? 'light' : 'dark')} className="p-1.5 rounded-full hover:bg-slate-700 transition-colors" title="Alternar Tema">
                                {isDark ? <Icons.Sun size={16} /> : <Icons.Moon size={16} />}
                            </button>
                            <button onClick={() => setShowFichaModal(true)} className="p-1.5 px-3 rounded-full hover:bg-blue-600 bg-blue-500 text-white transition-colors flex items-center gap-1 font-bold">
                                <Icons.Printer size={14} /> <span className="hidden md:inline">Gerar Ficha</span>
                            </button>
                            <div className="hidden md:flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Online</div>
                            <button onClick={() => setIsAuthenticated(false)} className="hover:text-red-300 transition-colors">Sair</button>
                        </div>
                    </div>

                    {/* Modal Gerar Ficha */}
                    {showFichaModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className={`p-6 rounded-xl shadow-xl w-full max-w-sm border ${isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-800'}`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold">Imprimir Ficha de Contagem</h3>
                                    <button onClick={() => setShowFichaModal(false)}><Icons.X size={20} /></button>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-sm font-medium mb-2 opacity-70">Selecione a Categoria</label>
                                    <select 
                                        value={fichaCategoria}
                                        onChange={(e) => setFichaCategoria(e.target.value)}
                                        className={`w-full border rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500 ${isDark ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-200'}`}
                                    >
                                        {categoriasDisponiveis.map(cat => (
                                            <option key={cat} value={cat}>{cat === 'TODAS' ? 'Todas as Categorias' : cat}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowFichaModal(false)} className={`px-4 py-2 text-sm rounded font-medium ${isDark ? 'hover:bg-slate-700' : 'hover:bg-slate-100'}`}>Cancelar</button>
                                    <button onClick={gerarFichaContagem} className="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 font-bold flex items-center gap-2">
                                        <Icons.Printer size={14} /> Gerar & Imprimir
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Controls */}
                    <header className={`border-b sticky top-0 z-30 px-6 py-4 shadow-sm transition-colors ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                        <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 max-w-7xl mx-auto">
                            <div className="flex flex-col md:flex-row gap-4 w-full xl:w-auto">
                                <div className="flex flex-col gap-1 w-full md:w-auto">
                                    <label className="text-[10px] font-bold uppercase flex items-center gap-1 opacity-60"><Icons.MapPin size={10} /> Escopo</label>
                                    <select value={unidadeAtual} onChange={(e) => { setUnidadeAtual(e.target.value); setPeriodoSelecionado(0); }} className={`font-bold text-lg py-2 pl-3 pr-10 rounded-lg outline-none cursor-pointer w-full md:w-auto md:min-w-[280px] appearance-none ${isDark ? 'bg-slate-700 text-white' : 'bg-slate-100 text-slate-800'}`} style={{backgroundImage: `url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22${isDark ? '%23ffffff' : '%23131313'}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E")`, backgroundRepeat: 'no-repeat', backgroundPosition: 'right .7em top 50%', backgroundSize: '.65em auto'}}><option value="TODAS">TODAS AS UNIDADES</option><option disabled>──────────────</option>{Object.keys(FILIAIS_CONFIG).map((key) => <option key={key} value={key}>{FILIAIS_CONFIG[key].nome}</option>)}</select>
                                </div>
                                <div className="flex flex-col gap-1 w-full md:w-auto">
                                    <label className="text-[10px] font-bold uppercase flex items-center gap-1 opacity-60"><Icons.Filter size={10} /> Categoria</label>
                                    <select value={categoriaSelecionada} onChange={(e) => setCategoriaSelecionada(e.target.value)} className={`border font-medium text-sm py-2 px-3 rounded-lg outline-none cursor-pointer w-full md:w-48 ${isDark ? 'bg-slate-700 border-slate-600 text-white' : 'bg-white border-slate-200 text-slate-700'}`}>{categoriasDisponiveis.map(cat => <option key={cat} value={cat}>{cat === 'TODAS' ? 'Todas as Bebidas' : cat}</option>)}</select>
                                </div>
                                {unidadeAtual !== 'TODAS' && dadosBI?.unidade?.contagens && (
                                    <div className="flex flex-col gap-1 w-full md:w-auto"><label className="text-[10px] font-bold uppercase flex items-center gap-1 opacity-60"><Icons.Calendar size={10} /> Período</label><select value={periodoSelecionado} onChange={(e) => setPeriodoSelecionado(Number(e.target.value))} className={`border font-medium text-sm py-2 px-3 rounded-lg outline-none cursor-pointer w-full md:w-48 ${isDark ? 'bg-slate-700 border-slate-600 text-white' : 'bg-white border-slate-200 text-slate-700'}`}>{dadosBI.unidade.contagens.map((c, idx) => idx > 0 && <option key={c.id} value={idx}>Inv. {formatDate(c.data)}</option>)}</select></div>
                                )}
                            </div>
                            {unidadeAtual !== 'TODAS' && (
                                <div className={`flex p-1 rounded-lg w-full xl:w-auto overflow-x-auto ${isDark ? 'bg-slate-700' : 'bg-slate-100'}`}>
                                    {['visao_geral', 'graficos', 'tabela'].map(tab => (
                                        <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 px-4 py-2 text-xs font-bold rounded-md transition-all flex items-center gap-2 justify-center whitespace-nowrap ${activeTab === tab ? (isDark ? 'bg-slate-600 text-blue-400 shadow-sm' : 'bg-white text-blue-600 shadow-sm') : (isDark ? 'text-slate-400 hover:text-white' : 'text-slate-500 hover:text-slate-700')}`}>
                                            {tab === 'visao_geral' && <Icons.Activity size={14} />}{tab === 'graficos' && <Icons.BarChart3 size={14} />}{tab === 'tabela' && <Icons.Table size={14} />}{tab.replace('_', ' ').toUpperCase()}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="p-6 max-w-7xl mx-auto">
                        {loading && <div className="text-center py-20 opacity-50 animate-pulse">Carregando dados...</div>}
                        
                        {!loading && (!dadosBI || (unidadeAtual === 'TODAS' && !dadosConsolidados) || (unidadeAtual !== 'TODAS' && !dadosAtuais)) && (
                            <EmptyState message={error || "Não foi possível carregar os dados de controle de estoque."} isDark={isDark} />
                        )}

                        {/* CONTEÚDO REAL */}
                        {!loading && !error && unidadeAtual === 'TODAS' && dadosConsolidados && chartsAvailable && (
                            <div className="animate-in slide-in-from-bottom-4 duration-500">
                                <div className="mb-6 flex items-center gap-2 opacity-80"><Icons.Building2 /><h2 className="text-xl font-bold">Visão Consolidada</h2></div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div className={`p-6 rounded-2xl border shadow-sm ${isDark ? 'bg-slate-800 border-red-900/50' : 'bg-gradient-to-br from-red-50 to-white border-red-100'}`}>
                                        <div className={`text-xs font-bold uppercase mb-2 flex items-center gap-2 ${isDark ? 'text-red-400' : 'text-red-800'}`}><Icons.TrendingDown size={14} /> Perda Total</div>
                                        <div className="text-4xl font-black text-red-600 mb-1">-{formatCurrency(dadosConsolidados.totalGeralPerda)}</div>
                                        <div className="text-xs opacity-60">Ref: {dadosConsolidados.dataReferencia}</div>
                                    </div>
                                    <div className={`p-6 rounded-2xl border shadow-sm ${isDark ? 'bg-slate-800 border-blue-900/50' : 'bg-gradient-to-br from-blue-50 to-white border-blue-100'}`}>
                                        <div className={`text-xs font-bold uppercase mb-2 flex items-center gap-2 ${isDark ? 'text-blue-400' : 'text-blue-800'}`}><Icons.DollarSign size={14} /> Valor Estoque</div>
                                        <div className="text-4xl font-black text-blue-600 mb-1">{formatCurrency(dadosConsolidados.totalGeralEstoque)}</div>
                                    </div>
                                    <div className={`p-6 rounded-2xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-gradient-to-br from-slate-50 to-white border-slate-200'}`}>
                                        <div className={`text-xs font-bold uppercase mb-2 flex items-center gap-2 ${isDark ? 'text-slate-400' : 'text-slate-600'}`}><Icons.ShoppingCart size={14} /> Vendas Totais</div>
                                        <div className={`text-4xl font-black mb-1 ${isDark ? 'text-slate-200' : 'text-slate-700'}`}>{formatCurrency(dadosConsolidados.totalGeralVenda)}</div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className={`p-6 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                        <h3 className="text-lg font-bold mb-4">Ranking de Prejuízo (R$)</h3>
                                        <div className="h-72">
                                            <SafeChart>
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <BarChart data={dadosConsolidados.rankingPerda} layout="vertical" margin={{left: 20, right: 30}}>
                                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} stroke={isDark ? '#334155' : '#e2e8f0'} />
                                                        <XAxis type="number" hide />
                                                        <YAxis dataKey="name" type="category" width={100} tick={{fontWeight: 'bold', fill: isDark ? '#94a3b8' : '#334155'}} />
                                                        <Tooltip formatter={(v) => formatCurrency(v)} contentStyle={{backgroundColor: isDark ? '#0f172a' : '#fff'}} />
                                                        <Bar dataKey="perda" fill="#ef4444" radius={[0,4,4,0]} barSize={30}>
                                                            <LabelList dataKey="perda" position="right" formatter={(v) => formatCurrency(v)} fill={isDark ? '#fff' : '#000'} fontSize={10} />
                                                        </Bar>
                                                    </BarChart>
                                                </ResponsiveContainer>
                                            </SafeChart>
                                        </div>
                                    </div>
                                    <div className={`p-6 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                        <h3 className="text-lg font-bold mb-4">Benchmarking: Acuracidade</h3>
                                        <div className="h-72">
                                            <SafeChart>
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <BarChart data={dadosConsolidados.rankingEficiencia} layout="vertical" margin={{left: 20}}>
                                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} stroke={isDark ? '#334155' : '#e2e8f0'} />
                                                        <XAxis type="number" domain={[0, 100]} hide />
                                                        <YAxis dataKey="name" type="category" width={100} tick={{fontWeight: 'bold', fill: isDark ? '#94a3b8' : '#334155'}} />
                                                        <Tooltip formatter={(v) => `${v.toFixed(1)}%`} contentStyle={{backgroundColor: isDark ? '#0f172a' : '#fff'}} />
                                                        <Bar dataKey="acuracidade" fill="#3b82f6" radius={[0,4,4,0]} barSize={30} />
                                                    </BarChart>
                                                </ResponsiveContainer>
                                            </SafeChart>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {!loading && !error && unidadeAtual !== 'TODAS' && dadosAtuais && (
                            <div className="animate-in slide-in-from-bottom-4 duration-500">
                                {dadosAtuais.observacoes && (
                                    <div className={`mb-6 border p-4 rounded-lg flex items-start gap-3 ${isDark ? 'bg-amber-900/30 border-amber-800' : 'bg-amber-50 border-amber-200'}`}>
                                        <Icons.Info className="text-amber-600 shrink-0 mt-0.5" size={20} />
                                        <div>
                                            <h4 className={`font-bold text-sm ${isDark ? 'text-amber-400' : 'text-amber-800'}`}>Ocorrência Operacional</h4>
                                            <p className={`text-sm ${isDark ? 'text-amber-200' : 'text-amber-700'}`}>{dadosAtuais.observacoes}</p>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'visao_geral' && (
                                    <>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                            <div className={`p-5 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <div className="flex justify-between items-start mb-2"><div className="text-xs font-bold uppercase opacity-60">Perda Financeira</div><Icons.TrendingDown size={16} className="text-red-500" /></div>
                                                <div className={`text-2xl font-black ${isDark ? 'text-slate-100' : 'text-slate-800'}`}>-{formatCurrency(dadosAtuais.perdaFinanceira)}</div>
                                            </div>
                                            <div className={`p-5 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <div className="flex justify-between items-start mb-2"><div className="text-xs font-bold uppercase opacity-60">Valor Estoque</div><Icons.DollarSign size={16} className="text-blue-500" /></div>
                                                <div className={`text-2xl font-black ${isDark ? 'text-slate-100' : 'text-slate-800'}`}>{formatCurrency(dadosAtuais.valorEstoqueAtual)}</div>
                                            </div>
                                            <div className={`p-5 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <div className="flex justify-between items-start mb-2"><div className="text-xs font-bold uppercase opacity-60">Margem</div><Icons.TrendingUp size={16} className="text-green-500" /></div>
                                                <div className={`text-2xl font-black ${isDark ? 'text-slate-100' : 'text-slate-800'}`}>{formatCurrency(dadosAtuais.margemTotal)}</div>
                                            </div>
                                            <div className={`p-5 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <div className="flex justify-between items-start mb-2"><div className="text-xs font-bold uppercase opacity-60">Acuracidade</div><Icons.CheckCircle size={16} className="text-purple-500" /></div>
                                                <div className={`text-2xl font-black ${isDark ? 'text-slate-100' : 'text-slate-800'}`}>{dadosAtuais.acuracidade.toFixed(1)}%</div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                            <div className={`p-6 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <h3 className="text-sm font-bold uppercase mb-4 flex items-center gap-2"><Icons.PackageX size={16} /> Estoque Morto (Sem vendas)</h3>
                                                <div className="space-y-3 overflow-auto max-h-64">
                                                    {dadosAtuais.detalhes.filter(i => i.statusGiro === 'morto').length === 0 ? (
                                                        <div className="text-sm opacity-60 py-4 text-center">Nenhum item parado detectado.</div>
                                                    ) : (
                                                        dadosAtuais.detalhes.filter(i => i.statusGiro === 'morto').map(item => (
                                                            <div key={item.id} className={`flex justify-between items-center p-3 rounded-lg border ${isDark ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-100'}`}>
                                                                <div><div className="font-bold text-sm">{item.nome}</div><div className="text-xs opacity-60">{item.final} unidades paradas</div></div>
                                                                <div className="text-right"><div className="text-xs font-bold opacity-60">Custo Parado</div><div className="font-bold">{formatCurrency(item.final * item.custo)}</div></div>
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            </div>
                                            <div className={`p-6 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <h3 className="text-sm font-bold uppercase mb-4 flex items-center gap-2"><Icons.Truck size={16} /> Sugestão de Reposição</h3>
                                                <div className="overflow-auto max-h-64">
                                                    <table className="w-full text-sm text-left">
                                                        <thead className={`text-xs uppercase ${isDark ? 'bg-slate-700 text-slate-400' : 'bg-slate-50 text-slate-400'}`}>
                                                            <tr><th className="px-3 py-2">Produto</th><th className="px-3 py-2 text-center">Atual</th><th className="px-3 py-2 text-right">Comprar</th></tr>
                                                        </thead>
                                                        <tbody>
                                                            {dadosAtuais.detalhes.filter(i => i.sugestaoCompra > 0).length === 0 ? (
                                                                <tr><td colSpan={3} className="p-4 text-center opacity-60">Estoque suficiente.</td></tr>
                                                            ) : (
                                                                dadosAtuais.detalhes.filter(i => i.sugestaoCompra > 0).map(item => (
                                                                    <tr key={item.id} className={`border-b ${isDark ? 'border-slate-700' : 'border-slate-100'}`}>
                                                                        <td className="px-3 py-2 font-medium">{item.nome}</td>
                                                                        <td className="px-3 py-2 text-center text-red-500 font-bold">{item.final}</td>
                                                                        <td className="px-3 py-2 text-right font-bold text-blue-600">+{item.sugestaoCompra}</td>
                                                                    </tr>
                                                                ))
                                                            )}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>

                                        {chartsAvailable && (
                                            <div className={`p-6 rounded-xl border shadow-sm mb-6 ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                <h3 className="text-lg font-bold mb-6 flex items-center gap-2"><Icons.TrendingUp size={20} className="text-blue-500" /> Evolução</h3>
                                                <div className="h-80 w-full">
                                                    <SafeChart>
                                                        <ResponsiveContainer width="100%" height="100%">
                                                            <ComposedChart data={dadosEvolucao}>
                                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={isDark ? '#334155' : '#f1f5f9'} />
                                                                <XAxis dataKey="name" tick={{fontSize: 12, fill: isDark ? '#94a3b8' : '#64748b'}} tickLine={false} axisLine={false} dy={10} />
                                                                <YAxis yAxisId="left" orientation="left" stroke="#3b82f6" tickFormatter={(v) => `R$${v}`} tickLine={false} axisLine={false} />
                                                                <YAxis yAxisId="right" orientation="right" stroke="#ef4444" tickFormatter={(v) => `R$${v}`} tickLine={false} axisLine={false} />
                                                                <Tooltip formatter={(value, name) => [formatCurrency(Number(value)), name === "Perdas" ? "Prejuízo" : "Vendas"]} contentStyle={{backgroundColor: isDark ? '#0f172a' : '#fff'}} />
                                                                <Legend iconType="circle" />
                                                                <Bar yAxisId="left" dataKey="Vendas" fill="#3b82f6" radius={[4, 4, 0, 0]} name="Vendas" barSize={50} />
                                                                <Line yAxisId="right" type="monotone" dataKey="Perdas" stroke="#ef4444" strokeWidth={3} dot={{r: 4}} name="Perdas" />
                                                            </ComposedChart>
                                                        </ResponsiveContainer>
                                                    </SafeChart>
                                                </div>
                                            </div>
                                        )}
                                    </>
                                )}

                                {activeTab === 'graficos' && chartsAvailable && (
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className={`p-6 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                            <h3 className="text-lg font-bold mb-2">Curva ABC</h3>
                                            <div className="h-64">
                                                <SafeChart>
                                                    <ResponsiveContainer width="100%" height="100%">
                                                        <PieChart>
                                                            <Pie 
                                                                data={[
                                                                    {name: 'Classe A', value: dadosAtuais.detalhes.filter(i=>i.curvaABC==='A').length},
                                                                    {name: 'Classe B', value: dadosAtuais.detalhes.filter(i=>i.curvaABC==='B').length},
                                                                    {name: 'Classe C', value: dadosAtuais.detalhes.filter(i=>i.curvaABC==='C').length}
                                                                ]} 
                                                                innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value"
                                                                label={({name, percent}) => `${name} ${(percent * 100).toFixed(0)}%`}
                                                            >
                                                                <Cell fill="#3b82f6" /><Cell fill="#f59e0b" /><Cell fill="#94a3b8" />
                                                            </Pie>
                                                            <Tooltip />
                                                        </PieChart>
                                                    </ResponsiveContainer>
                                                </SafeChart>
                                            </div>
                                        </div>
                                        <div className={`p-6 rounded-xl border shadow-sm ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                            <h3 className="text-lg font-bold mb-2">Top 5 Prejuízo</h3>
                                            <div className="h-64">
                                                <SafeChart>
                                                    <ResponsiveContainer width="100%" height="100%">
                                                        <BarChart layout="vertical" data={[...dadosAtuais.detalhes].filter(d=>d.perdaFinanceira<0).sort((a,b)=>a.perdaFinanceira-b.perdaFinanceira).slice(0,5)} margin={{left: 20, right: 30}}>
                                                            <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} stroke={isDark ? '#334155' : '#e2e8f0'} />
                                                            <XAxis type="number" hide />
                                                            <YAxis type="category" dataKey="nome" width={100} tick={{fontSize: 10, fill: isDark ? '#94a3b8' : '#64748b'}} />
                                                            <Tooltip formatter={(v) => formatCurrency(Number(v))} contentStyle={{backgroundColor: isDark ? '#0f172a' : '#fff'}} />
                                                            <Bar dataKey="perdaAbsoluta" fill="#ef4444" radius={[0,4,4,0]} barSize={24} name="Perda">
                                                                <LabelList dataKey="perdaAbsoluta" position="right" formatter={(v) => formatCurrency(v)} fill={isDark ? '#fff' : '#000'} fontSize={10} />
                                                            </Bar>
                                                        </BarChart>
                                                    </ResponsiveContainer>
                                                </SafeChart>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'tabela' && (
                                    <div className={`rounded-xl shadow-sm border overflow-hidden ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className={`font-semibold border-b whitespace-nowrap ${isDark ? 'bg-slate-900 text-slate-400 border-slate-700' : 'bg-slate-50 text-slate-500 border-slate-200'}`}>
                                                    <tr>
                                                        <th className="px-4 py-3 cursor-pointer hover:bg-black/5" onClick={() => requestSort('nome')}>Produto <SortIcon active={sortConfig.key === 'nome'} direction={sortConfig.direction} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:bg-black/5" onClick={() => requestSort('inicial')}>Anterior <SortIcon active={sortConfig.key === 'inicial'} direction={sortConfig.direction} /></th>
                                                        <th className="px-4 py-3 text-center text-green-600 cursor-pointer hover:bg-black/5" onClick={() => requestSort('entrada')}>(+) Ent. <SortIcon active={sortConfig.key === 'entrada'} direction={sortConfig.direction} /></th>
                                                        <th className="px-4 py-3 text-center text-red-400 cursor-pointer hover:bg-black/5" onClick={() => requestSort('vendas')}>(-) Sai. <SortIcon active={sortConfig.key === 'vendas'} direction={sortConfig.direction} /></th>
                                                        <th className="px-4 py-3 text-center text-blue-500 cursor-pointer hover:bg-black/5" onClick={() => requestSort('teorico')}>(=) Teórico <SortIcon active={sortConfig.key === 'teorico'} direction={sortConfig.direction} /></th>
                                                        <th className="px-4 py-3 text-center bg-slate-100 dark:bg-slate-700/50 cursor-pointer hover:bg-black/5" onClick={() => requestSort('final')}>Atual <SortIcon active={sortConfig.key === 'final'} direction={sortConfig.direction} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:bg-black/5" onClick={() => requestSort('diferenca')}>Dif. <SortIcon active={sortConfig.key === 'diferenca'} direction={sortConfig.direction} /></th>
                                                        <th className="px-4 py-3 text-right cursor-pointer hover:bg-black/5" onClick={() => requestSort('perdaFinanceira')}>Perda R$ <SortIcon active={sortConfig.key === 'perdaFinanceira'} direction={sortConfig.direction} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:bg-black/5" onClick={() => requestSort('status')}>Status <SortIcon active={sortConfig.key === 'status'} direction={sortConfig.direction} /></th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                                                    {sortedItems.map((item) => (
                                                        <tr key={item.id} className={`transition-colors ${isDark ? 'hover:bg-slate-700' : 'hover:bg-slate-50'}`}>
                                                            <td className="px-4 py-3 font-medium">{item.nome}</td>
                                                            <td className="px-4 py-3 text-center opacity-70">{item.inicial}</td>
                                                            <td className="px-4 py-3 text-center text-green-600">{item.entrada || '-'}</td>
                                                            <td className="px-4 py-3 text-center text-red-400">{item.vendas}</td>
                                                            <td className="px-4 py-3 text-center font-bold text-blue-500">{item.teorico}</td>
                                                            <td className="px-4 py-3 text-center font-bold bg-slate-50 dark:bg-slate-800">{item.final}</td>
                                                            <td className={`px-4 py-3 text-center font-bold ${item.diferenca < 0 ? 'text-red-500' : 'text-green-500'}`}>{item.diferenca}</td>
                                                            <td className="px-4 py-3 text-right font-medium text-red-500">{item.perdaFinanceira < 0 ? formatCurrency(item.perdaAbsoluta) : '-'}</td>
                                                            <td className="px-4 py-3 text-center"><StatusBadge type={item.status} text={item.status} /></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                                {totaisTabela && (
                                                    <tfoot className={`font-bold ${isDark ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-800'}`}>
                                                        <tr>
                                                            <td className="px-4 py-3 text-right">TOTAIS:</td>
                                                            <td className="px-4 py-3 text-center">{totaisTabela.inicial}</td>
                                                            <td className="px-4 py-3 text-center text-green-600">{totaisTabela.entrada}</td>
                                                            <td className="px-4 py-3 text-center text-red-400">{totaisTabela.vendas}</td>
                                                            <td className="px-4 py-3 text-center text-blue-500">{totaisTabela.teorico}</td>
                                                            <td className="px-4 py-3 text-center">{totaisTabela.final}</td>
                                                            <td className={`px-4 py-3 text-center ${totaisTabela.diferenca < 0 ? 'text-red-500' : 'text-green-500'}`}>{totaisTabela.diferenca}</td>
                                                            <td className="px-4 py-3 text-right text-red-500">{formatCurrency(Math.abs(totaisTabela.perdaFinanceira))}</td>
                                                            <td></td>
                                                        </tr>
                                                    </tfoot>
                                                )}
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
